name: Deploy to Vercel - Optimized

on:
  push:
    branches: [main, master, v3]
    paths: 
      - '.next-cache/**'
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'next.config.mjs'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even without cache changes'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_ENV: production
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone for faster checkout
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: âš¡ Install dependencies
        run: npm ci
      
      - name: ğŸ“¥ Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: ğŸ” Validate environment and cache
        run: |
          echo "ğŸ” Validating deployment requirements..."
          
          # Check required secrets
          if [ -z "$VERCEL_TOKEN" ] || [ -z "$VERCEL_ORG_ID" ] || [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "âŒ Missing required Vercel secrets!"
            echo "Required: VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID"
            exit 1
          fi
          
          # Validate cache directory
          if [ ! -d ".next-cache" ]; then
            echo "âŒ .next-cache directory not found!"
            echo "ğŸ’¡ Run 'npm run optimize' locally and commit the cache"
            exit 1
          fi
          
          # Count processed files
          JSON_COUNT=$(find .next-cache -name "*.json" -not -name "file-hashes.json" | wc -l)
          MANIFEST_EXISTS=$([ -f ".next-cache/manifest.json" ] && echo "âœ…" || echo "âŒ")
          
          echo "ğŸ“Š Cache Status:"
          echo "   ğŸ“„ JSON files: $JSON_COUNT"
          echo "   ğŸ“‹ Manifest: $MANIFEST_EXISTS"
          echo "   ğŸ’¾ Cache size: $(du -sh .next-cache/ | cut -f1)"
          
          if [ $JSON_COUNT -eq 0 ]; then
            echo "âŒ No processed data files found in cache!"
            exit 1
          fi
          
          echo "âœ… Cache validation passed"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: ğŸ§ª Test Vercel authentication
        run: |
          echo "ğŸ” Testing Vercel authentication..."
          
          WHOAMI_OUTPUT=$(vercel whoami --token="$VERCEL_TOKEN" 2>&1)
          
          if echo "$WHOAMI_OUTPUT" | grep -q "Error\|Invalid"; then
            echo "âŒ Vercel authentication failed:"
            echo "$WHOAMI_OUTPUT"
            exit 1
          fi
          
          echo "âœ… Authenticated as: $WHOAMI_OUTPUT"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      
      - name: ğŸ—ï¸ Build Next.js application
        run: |
          echo "ğŸ—ï¸ Building Next.js application..."
          
          npm run build
          
          # Verify build output
          if [ ! -d ".next" ]; then
            echo "âŒ Build failed - .next directory not created"
            exit 1
          fi
          
          echo "âœ… Build completed successfully"
          echo "ğŸ“Š Build size: $(du -sh .next/ | cut -f1)"
      
      - name: ğŸ“‹ Configure Vercel project
        run: |
          echo "ğŸ“‹ Configuring Vercel project..."
          
          # Create .vercel directory and project.json
          mkdir -p .vercel
          
          cat > .vercel/project.json << EOF
          {
            "orgId": "${{ secrets.VERCEL_ORG_ID }}",
            "projectId": "${{ secrets.VERCEL_PROJECT_ID }}"
          }
          EOF
          
          echo "âœ… Vercel project configured"
      
      - name: ğŸš€ Deploy to Vercel
        id: deploy
        run: |
          echo "ğŸš€ Starting deployment to Vercel..."
          
          # Deploy with proper error handling
          DEPLOY_OUTPUT=$(vercel deploy --prod --token="$VERCEL_TOKEN" 2>&1)
          DEPLOY_EXIT_CODE=$?
          
          echo "ğŸ“¤ Deployment output:"
          echo "$DEPLOY_OUTPUT"
          
          if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
            # Extract deployment URL
            DEPLOYMENT_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*' | head -1)
            
            if [ -n "$DEPLOYMENT_URL" ]; then
              echo "âœ… Deployment successful!"
              echo "ğŸŒ Live URL: $DEPLOYMENT_URL"
              echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Deployment completed but URL not found in output"
            fi
          else
            echo "âŒ Deployment failed with exit code: $DEPLOY_EXIT_CODE"
            exit 1
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: ğŸ§ª Verify deployment
        if: steps.deploy.outputs.deployment_url
        run: |
          echo "ğŸ§ª Verifying deployment..."
          
          DEPLOYMENT_URL="${{ steps.deploy.outputs.deployment_url }}"
          
          # Wait a moment for deployment to be ready
          sleep 10
          
          # Test if site responds
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$DEPLOYMENT_URL" || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Site is responding correctly (HTTP $HTTP_STATUS)"
          else
            echo "âš ï¸ Site returned HTTP $HTTP_STATUS - may still be propagating"
          fi
          
          # Test API endpoints
          API_MANIFEST="$DEPLOYMENT_URL/api/manifest.json"
          API_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$API_MANIFEST" || echo "000")
          
          if [ "$API_STATUS" = "200" ]; then
            echo "âœ… API endpoints are working (HTTP $API_STATUS)"
          else
            echo "âš ï¸ API returned HTTP $API_STATUS"
          fi
      
      - name: ğŸ“Š Deployment summary
        if: success()
        run: |
          echo "ğŸ‰ Deployment Summary"
          echo "===================="
          echo "âœ… Status: SUCCESS"
          echo "ğŸŒ URL: ${{ steps.deploy.outputs.deployment_url || 'Check Vercel dashboard' }}"
          echo "ğŸ“¦ Cache files deployed: $(find .next-cache -name "*.json" -not -name "file-hashes.json" | wc -l)"
          echo "âš¡ Static API routes: $(find public/api -name "*.json" 2>/dev/null | wc -l || echo 0)"
          echo "ğŸ” SEO files: $(ls public/sitemap.xml public/robots.txt 2>/dev/null | wc -l) of 2"
          echo ""
          echo "ğŸš€ Your Excel-powered website is now live!"
          echo "ğŸ“ˆ Fast loading with pre-processed static data"
          echo "ğŸ” SEO optimized with sitemap and meta tags"
      
      - name: ğŸ” Debug on failure
        if: failure()
        run: |
          echo "âŒ Deployment Failed - Debug Information"
          echo "======================================="
          echo ""
          echo "ğŸ“ Current directory contents:"
          ls -la
          echo ""
          echo "ğŸ“„ Cache directory status:"
          if [ -d ".next-cache" ]; then
            ls -la .next-cache/
          else
            echo "âŒ .next-cache directory not found"
          fi
          echo ""
          echo "ğŸ—ï¸ Build directory status:"
          if [ -d ".next" ]; then
            echo "âœ… .next directory exists"
            du -sh .next/
          else
            echo "âŒ .next directory not found"
          fi
          echo ""
          echo "âš™ï¸ Node.js environment:"
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo ""
          echo "ğŸ”§ Vercel CLI info:"
          vercel --version || echo "âŒ Vercel CLI not available"
          echo ""
          echo "ğŸ’¡ Troubleshooting tips:"
          echo "1. Check that all secrets are correctly configured"
          echo "2. Ensure .next-cache contains processed JSON files"
          echo "3. Verify vercel.json configuration is valid"
          echo "4. Check build logs above for specific errors"
      
      - name: ğŸ“ Add PR comment
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.deployment_url }}';
            const comment = deploymentUrl 
              ? `ğŸš€ **Preview deployment ready!**\n\nğŸŒ **URL:** ${deploymentUrl}\n\nâœ… Deployed with static Excel cache`
              : 'ğŸš€ **Deployment completed!** Check your Vercel dashboard for the preview URL.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });