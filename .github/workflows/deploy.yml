name: Process Excel Data & Deploy

on:
  push:
    branches: [v3, v3_prod]
    paths: 
      - 'data/excel/**'  # Trigger when Excel files change
      - 'scripts/**'     # Or when processing scripts change
      - 'src/**'         # Or when app code changes
  workflow_dispatch:

env:
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  process-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ”§ Install dependencies
        run: npm ci
      
      - name: ğŸ”„ Process Excel Files to JSON
        run: |
          echo "ğŸ”„ Processing Excel files..."
          npm run optimize
          
          echo "ğŸ“Š Processing complete!"
          echo "Cache files: $(find .next-cache -name "*.json" | wc -l)"
          echo "Cache size: $(du -sh .next-cache/ | cut -f1)"
      
      - name: ğŸ“ Commit processed data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .next-cache/
          git add public/sitemap.xml || true
          git add public/robots.txt || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Auto-update processed Excel data [skip ci]"
            git push
            echo "âœ… Processed data committed and pushed"
          fi
      
      - name: ğŸ‰ Success
        run: |
          echo "ğŸš€ Excel processing completed successfully!"
          echo "ğŸ“¦ Vercel will auto-deploy updated content"
          echo "âš¡ Fresh data will be available shortly"