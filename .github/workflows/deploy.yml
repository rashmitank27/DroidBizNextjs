name: Process Excel Data & Deploy

on:
  push:
    branches: [v3_dev]
    paths: 
      - 'data/excel/**'  # Trigger when Excel files change
      - 'scripts/**'     # Or when processing scripts change
      - 'src/**'         # Or when app code changes
  workflow_dispatch:

env:
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  process-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: 🔧 Install dependencies
        run: npm install
      
      - name: 🔄 Process Excel Files to JSON
        run: |
          echo "🔄 Processing Excel files..."
          npm run optimize
          
          echo "📊 Processing complete!"
          echo "Cache files: $(find .next-cache -name "*.json" | wc -l)"
          echo "Cache size: $(du -sh .next-cache/ | cut -f1)"
      
      - name: 📝 Commit processed data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .next-cache/
          git add public/api/ || true
          git add public/sitemap.xml || true
          git add public/robots.txt || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "🤖 Auto-update processed Excel data [skip ci]"
            git push
            echo "✅ Processed data committed and pushed"
          fi
      
      - name: ⏳ Wait for Vercel deployment
        run: |
          echo "🚀 Processed data pushed to repository"
          echo "⏳ Vercel will automatically deploy the updated data"
          echo "🔗 Check your Vercel dashboard for deployment status"
      
      - name: 🔍 Debug on failure
        if: failure()
        run: |
          echo "❌ Processing failed!"
          echo "📁 Excel files found:"
          find data/excel -name "*.xlsx" 2>/dev/null || echo "No Excel files found"
          echo "📄 Cache status:"
          ls -la .next-cache/ || echo "No cache directory"